<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>添加权限修改</title>
    <link href="../../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../dist/css/sb-admin-2.css" rel="stylesheet">
    <link href="../../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="../../css/admin.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" type="text/css" href="../../resource/zTree/css/zTreeStyle/zTreeStyle.css" />
    <style>
        label{padding-right: 0;padding-top: 6px}
    </style>
</head>
<body style="width: 96%">
	<div>
    	<div style="width: 100%;">
    		<form class="form-horizontal" role="form" style="margin-top: 20px" id="defaultForm">
                <div class="form-group">
                    <label class="col-xs-4  control-label text-right" for="companyId" >公司：</label>
                    <div class="col-xs-6">
                        <select class="form-control" id="companyId" name="companyId">
                            <option value="">请选择公司</option>
                            <#if companyList?? && companyList?size gt 0>
                            <#list companyList as company>
                            <option value="${company.id}">${company.company_name}</option>
                            </#list>
                            </#if>
                        </select>
                    </div>
                </div>
			    <div class="form-group">
			        <label class="col-xs-4  control-label text-right" for="roleId" >角色：</label>
			         <div class="col-xs-6">
			            <select class="form-control" id="roleId" name="roleId">
			  				<option value="">请选择角色</option>
						</select>
			        </div>
			    </div>
			    <div class="form-group">
			        <label class="col-xs-4  control-label text-right" for="authority">权限：</label>
			        <div class="col-xs-6">
			        	<ul id="authority" class="ztree"></ul>
			        </div>
			    </div>
			    <div class="form-group">
			        <label class="col-xs-4  control-label" for="v"></label>
			        <div class="col-xs-6 text-right">
			            <button type="button" class="btn btn-default" id="cancel">取消</button>
			            <button id="v" type="submit" class="btn btn-primary">保存</button>
			        </div>
			    </div>
			</form>
    	</div>   		    	
	</div>	

	<script src="../../vendor/jquery/jquery.min.js"></script>
	<script src="../../vendor/bootstrap/js/bootstrap.min.js"></script>
	<script src="../../resource/bootstrapvalidator/js/bootstrapValidator.min.js"></script>
	<script src="../../js/common/admin.js"></script>
	<script type="text/javascript" src="../../resource/zTree/js/jquery.ztree.core-3.5.js"></script>
	<script type="text/javascript" src="../../resource/zTree/js/jquery.ztree.excheck-3.5.js"></script>
	<script type="text/javascript">
	$(function () {
		$('form').bootstrapValidator({
			message: 'This value is not valid',
			feedbackIcons: {
				valid: 'glyphicon glyphicon-ok',
				invalid: 'glyphicon glyphicon-remove',
				validating: 'glyphicon glyphicon-refresh'
							},　　　
			fields: {
				role: {
					message: '用户名验证失败',
					validators: {
						notEmpty: {
							message: '角色不能为空'
						},
						regexp: {
							regexp: /^[a-zA-Z0-9_\u4e00-\u9fa5\\s·]+$/,
							message: '不能有特殊字符'
						}
					}
				},
			}
		});
	}).on('success.form.bv', function(e) {
        e.preventDefault();

        // 角色 id
        var roleId = $('#roleId').val();

        var treeObj = $.fn.zTree.getZTreeObj("authority");
        var nodes = treeObj.getCheckedNodes(true);
        //console.log(nodes);
        if(nodes.length == 0){
            layer.msg('请选择添加权限');return;
        }
        var myArray = new Array(nodes.length);
        for (var a = 0; a < nodes.length; a++) {
            myArray[a] = nodes[a].id;
        }
        // 菜单 ids
        var menuIds = myArray.join();

        $.post("/system/saveAuthority",{"roleId":roleId, "menuIds": menuIds}, function(result) {
            if (result) {
                parent.layer.msg("保存成功", {time: 2000}, function(){
                    layer_close();
                    parent.parent.refresh_iframe();
                });

            } else {
                parent.layer.msg('保存失败', {icon: 1});
            }

        });
    });

    // 权限树
	var setting ={
		enable:false,
		check:{
			enable:true,
			chkStyle:"checkbox",

		},
		data:{
			simpleData:{
				enable:true
				,idKey:"id"
				,pIdKey:"pId"
			}
		}
	};

	var zTreeNodes = ${menuListJson!};
	/*var zTreeNodes = [
					  {id:1,pId:0,name:"用户管理",checked:true,open:true},
					  {id:11,pId:1,name:"公司管理",checked:true,open:true},
					  {id:111,pId:11,name:"查询",open:true},
					  {id:111,pId:11,name:"添加"},
					  {id:111,pId:11,name:"编辑"},
					  {id:111,pId:11,name:"冻结/启用"},
					  {id:12,pId:1,name:"部门管理"},
					  {id:121,pId:12,name:"查询"},
					  {id:122,pId:12,name:"添加"},
					  {id:123,pId:12,name:"编辑"},
					  {id:124,pId:12,name:"冻结/启用"},
					  {id:13,pId:1,name:"角色管理"},
					  {id:131,pId:13,name:"添加"},
					  {id:132,pId:13,name:"编辑"},
					  {id:133,pId:13,name:"删除"},
					  {id:14,pId:1,name:"权限管理"},
					  {id:141,pId:14,name:"权限"},
					  {id:2,pId:0,name:"供应商管理",checked:true},
					  {id:21,pId:2,name:"公司管理",checked:true},
					  {id:211,pId:21,name:"查询"},
					  {id:211,pId:21,name:"添加"},
					  {id:211,pId:21,name:"编辑"},
					  {id:211,pId:21,name:"冻结/启用"},
					  {id:22,pId:2,name:"部门管理"},
					  {id:221,pId:22,name:"查询"},
					  {id:222,pId:22,name:"添加"},
					  {id:223,pId:22,name:"编辑"},
					  {id:224,pId:22,name:"冻结/启用"},
					  {id:23,pId:2,name:"角色管理"},
					  {id:231,pId:23,name:"添加"},
					  {id:232,pId:23,name:"编辑"},
					  {id:233,pId:23,name:"删除"},
					  {id:24,pId:2,name:"权限管理"},
					  {id:241,pId:24,name:"权限"},
					  {id:3,pId:0,name:"预报价管理",checked:true},
					  {id:31,pId:3,name:"公司管理",checked:true},
					  {id:311,pId:31,name:"查询"},
					  {id:311,pId:31,name:"添加"},
					  {id:311,pId:31,name:"编辑"},
					  {id:311,pId:31,name:"冻结/启用"},
					  {id:32,pId:3,name:"部门管理"},
					  {id:321,pId:32,name:"查询"},
					  {id:322,pId:32,name:"添加"},
					  {id:323,pId:32,name:"编辑"},
					  {id:324,pId:32,name:"冻结/启用"},
					  {id:33,pId:3,name:"角色管理"},
					  {id:331,pId:33,name:"添加"},
					  {id:332,pId:33,name:"编辑"},
					  {id:333,pId:33,name:"删除"},
					  {id:34,pId:3,name:"权限管理"},
					  {id:341,pId:34,name:"权限"},
					  ];*/
	$.fn.zTree.init($("#authority"), setting, zTreeNodes);


    // 根据公司 id 获取角色列表
    $('#companyId').change(function() {
        // 公司 id
        var companyId = $(this).val();
        // 清空部门下拉菜单
        $('#roleId').empty().append('<option value="">请选择角色</option>');
        // 获取部门列表
        if (!("" === companyId)) {
            $.post('/system/getRoleByCompanyId/'+ companyId, function (roleList) {
                $(roleList).each(function () {
                    $('#roleId').append('<option value="'+ this.id +'">'+ this.role_type +'</option>');
                });
            } );
        }
    });

    //取消
    $('#cancel').on("click",function() {
        layer_close();
    });
	</script>
</body>
</html>