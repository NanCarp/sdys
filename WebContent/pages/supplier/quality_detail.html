<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>供应商资质管理</title>

    <!-- Bootstrap Core CSS -->
    <link href="../../../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="../../../vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="../../../dist/css/sb-admin-2.css" rel="stylesheet">
    <link href="../../../css/admin.css" rel="stylesheet">
    <link href="../../../resource/bootstrapvalidator/css/bootstrapValidator.min.css" rel="stylesheet">
    <link href="../../../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="../../../resource/bootstrap-fileinput/css/fileinput.css" rel="stylesheet">
	<style type="text/css">
		body { margin:0 15px;}
		form { margin-top:20px;}
		label { padding-top:6px;padding-right:0;}
	</style>
	
    <!-- Custom Fonts -->
    <link href="../../../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body style="width:85%;">
    <form id="defaultForm" class="form-horizontal" role="form" enctype="multipart/form-data">
    	<#if quality??>
    	<input hidden="" name="id" value="${quality.id}" id="id">
        <div class="form-group">
            <label class="col-xs-4 col-xs-offset-1 control-label text-right" for="companyId">公司：</label>
            <div class="col-xs-6">
                <select class="form-control" id="companyId" name="companyId">
                    <#if companyList??>
                    <#list companyList as company>
                    <option value="${company.id}" <#if company.id == quality.supplier_id>selected<#else>style="display:none;"</#if>>${company.company_name}</option>
                    </#list>
                    </#if>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-xs-5 control-label text-right" for="abbreviation">简称：</label>
            <div class="col-xs-6">
                <input class="form-control" id="abbreviation" type="text" placeholder=" 简称"  name="abbreviation" value="${quality.short_name!}"/>
            </div>
        </div>
	    <div class="form-group">
            <label class="col-xs-5 control-label text-right" for="state">状态：</label>
            <div class="col-xs-6">
            	<select id="state" class="form-control" name="state">
	                <option value="">请选择状态</option>
	                <option value="1" <#if quality.state==1>selected="selected"</#if>>合格</option>
	                <option value="2" <#if quality.state==2>selected="selected"</#if>>备选</option>
	                <option value="0" <#if quality.state==0>selected="selected"</#if>>不合格</option>
	            </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-xs-5 control-label text-right" for="file" style="padding-top:0;">资质文件：</label>
            <div class="col-xs-6">
                <input type="file" class="file" id="file" name="file" value="${quality.review_file!}">
                <div id="url"></div>
            </div>
        </div>
        <div class="form-group">
            <label class="col-xs-5 control-label text-right" for="remark" style="padding-top:0;">备注：</label>
            <div class="col-xs-6">
                <textarea class="form-control" id="remark" type="text" placeholder=" 备注" name="remark">${quality.remark!}</textarea>
            </div>
        </div>
    	<#else>
        <div class="form-group">
			<label class="col-xs-5 control-labell text-right" for="companyId">货代名称：</label>
            <div class="col-xs-6">
                <select class="form-control" id="companyId" name="companyId">
                    <option value="">请选择公司</option>
                    <#if companyList??>
                    <#list companyList as company>
                    <option value="${company.id}">${company.company_name}</option>
                    </#list>
                    </#if>
                </select>
            </div>
	    </div>
        <div class="form-group">
			<label class="col-xs-5 control-label text-right" for="abbreviation">简称：</label>
			<div class="col-xs-6">
	            <input class="form-control" id="abbreviation" type="text" placeholder=" 简称"  name="abbreviation"/>
	        </div>
	    </div>
	    <div class="form-group">
            <label class="col-xs-5 control-label text-right" for="state">状态：</label>
            <div class="col-xs-6">
            	<select id="state" class="form-control" name="state">
	                <option value="">请选择状态</option>
	                <option value="1">合格</option>
	                <option value="2">备选</option>
	                <option value="0">不合格</option>
	            </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-xs-5 control-label text-right" for="file" style="padding-top:0;">资质文件：</label>
            <div class="col-xs-6">
                <input type="file" class="file" id="file" name="file" value="">
                <div id="url"></div>
            </div>
        </div>
        <div class="form-group">
            <label class="col-xs-5 control-label text-right" for="remark" style="padding-top:0;">备注：</label>
            <div class="col-xs-6">
                <textarea class="form-control" id="remark" placeholder=" 备注" name="remark"></textarea>
            </div>
        </div>
        </#if>
        <div class="form-group">
            <label class="col-xs-5 control-label" for="v5"></label>
            <div class="col-xs-6 text-right">
	            <button type="button" class="btn btn-10" onclick="_close()">取消</button>
	            <button type="submit" class="btn btn-11" id="save">保存</button>
        	</div>
        </div>
    </form>
<!-- jQuery -->
<script src="../../../resource/jquery-3.2.1/jquery-3.2.1.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="../../../vendor/bootstrap/js/bootstrap.min.js"></script>

<!-- Metis Menu Plugin JavaScript -->
<script src="../../../vendor/metisMenu/metisMenu.min.js"></script>
<script src="../../../resource/layui/layui.js"></script>
<!-- Custom Theme JavaScript -->
<script src="../../../resource/bootstrap-fileinput/js/fileinput.js"></script>
<script src="../../../resource/bootstrap-fileinput/js/locales/zh.js"></script>
<script src="../../../dist/js/sb-admin-2.js"></script>
<script src="../../../resource/bootstrapvalidator/js/bootstrapValidator.min.js"></script>
<script src="../../../js/common/admin.js"></script>
<script type="text/javascript">

// 文件上传
// 初始化fileinput控件（第一次初始化）
var fileList = new Array();//定义一个全局变量去接受文件名和id

function initFileInput(ctrlName, uploadUrl) {
    var control = $('#' + ctrlName);

    control.fileinput({
        language: 'zh', //设置语言
        uploadUrl: uploadUrl, //上传的地址
        // allowedFileExtensions : ['jpg', 'png','gif'],//接收的文件后缀
        showUpload: false, //是否显示上传按钮
        showCaption: false,//是否显示标题
        showRemove: false, //
        //showUploadedThumbs: false,//
        browseClass: "btn btn-primary", //按钮样式
        dropZoneEnabled: false,//是否显示拖拽区域
        showPreview :false,//是否显示预览
        enctype: 'multipart/form-data',
        previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
    }).on("filebatchselected", function(event, files) {// 上传文件
        $(this).fileinput("upload");
    }).on("fileuploaded", function(event, data, previewId, index) {// 上传成功后的回调函数
        if(data.response) {
            var fileName = data.response.fileName;
            fileList.push({fileName: fileName, keyId : previewId});
            $('#url').empty().append('<p><span style="width: 90%;float: left;">'+fileName+'</span><a href="javascript:;" onclick="del(this)" style="width: 10%;float: left;"><i class="fa fa-times" title="删除"></i></a></br></p>');
        }
    }).on('filesuccessremove', function(event,id) {// 上传成功后，点击删除按钮的回调函数
        console.log("filesuccessremove: " + id);
    }).on('fileclear', function(event) {
        console.log("fileclear");
    });
}

initFileInput("file", "/supplier/quality/uploadQualityFile");


/*// 文件上传，显示文件名
$('body').delegate('#file','change',function(e){
    //console.log($(this).val())//e就是你获取的file对象
    var file = $(this).val();
    var strFileName=file.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");  //正则表达式获取文件名，不带后缀
    var FileExt=file.replace(/.+\./,"");   //正则表达式获取后缀
    var fileName = strFileName + "." + FileExt;
    //console.log(fileName);
    if ("." !== fileName) {
        $('#url').empty().append('<p><span style="width: 90%;float: left;">'+fileName+'</span><a href="javascript:;" onclick="del(this)" style="width: 10%;float: left;"><i class="fa fa-times" title="删除"></i></a></br></p>');
    } else {
        $('#url').empty();
    }
})*/
// 删除选中文件
function del(_obj){
    var fileName = $('#url span').html();
    //console.log(fileName);
    $.post("/supplier/quality/deleteQualityFile",{"fileName":fileName},function (data) {
        if (data) {
            parent.layer.msg("删除成功", {time: 1000});

        } else {
            parent.layer.msg('删除失败', {time: 1000});
        }
    });
    $(_obj).parent('p').remove();
    $("#file").val("");
}
// 回显文件
$(function () {
    var fileName = '${fileName!""}';
    if ("" !== fileName) {
        $('#url').empty().append('<p><span style="width: 90%;float: left;">'+fileName+'</span><a href="javascript:;" onclick="del(this)" style="width: 10%;float: left;"><i class="fa fa-times" title="删除"></i></a></br></p>');
    }
});


// 表单校验
$('#defaultForm').bootstrapValidator({
	message: 'This value is not valid',
	feedbackIcons: {
		valid: 'glyphicon glyphicon-ok',
		invalid: 'glyphicon glyphicon-remove',
		validating: 'glyphicon glyphicon-refresh'
	},
	fields: {
		companyId: {
			validators: {
				notEmpty: {
					message: '请选择供应商!'
				}
			},
		},
		abbreviation: {
			validators: {
				notEmpty: {
                    message: '不能为空!'
                },
			    regexp: {
					regexp: /^[a-zA-Z0-9_\u0391-\uFFE5\S]+$/,
					message: '不能包含空格、美元符号等特殊字符'
				},
                stringLength: {
                    min: 2,
                    max: 20,
                    message: '2~15个字符'
                }
			}
		},
		state: {
			validators: {
				notEmpty: {
					message: '不能为空!'
				}
			}
		},
		file: {
			validators: {

			}
		},
		remark: {
			validators: {
				stringLength: {
                    min: 0,
                    max: 100,
                    message: '最多100个字符'
                }
			}
		}
	},
})
.on('success.form.bv', function(e) {
	e.preventDefault();
    var id = $('#id').val();// 资质 id
    var msg = "新增物流公司资质成功！";// 提示信息
    if (id != null) {
    	msg = "编辑物流公司资质成功！";
    }
    var companyId = $('#companyId').val();
    var abbreviation = $('#abbreviation').val();
    var state = $('#state').val();
    var file = $('#url span').html();
    // var file = fileList[0]["fileName"];
    var remark = $('#remark').html();
	var postData = {'id': id, 'companyId': companyId, 'abbreviation': abbreviation, 'state': state, 'file': file, 'remark': remark};

    $.post("/supplier/quality/saveQuality", postData, function(result) {
		if (result) {
			parent.layer.msg(msg, {time: 2000}, function(){
				layer_close();
				parent.parent.refresh_iframe();
			});

		} else {
			parent.layer.msg('系统异常，请稍后再试！', {time: 2000});
		}
	});

    /*
    // 同步传输
    var postdata = new FormData(document.getElementById('defaultForm'));
    $.ajax({
        url:"/supplier/quality/saveQuality",
        type:"post",
        data:postdata,
        cache: false,
        processData: false,
        contentType: false,
        success:function(result){
            if (result) {
                parent.layer.msg("保存成功", {time: 2000}, function(){
                    layer_close();
                    parent.parent.refresh_iframe();
                });

            } else {
                parent.layer.msg('保存失败', {time: 2000});
            }
        },
        error:function(e){
            alert("网络错误，请重试！！");
        }
    });*/
});

// 取消
function _close() {
	/* var index = parent.layer.getFrameIndex(window.name);
	parent.layer.close(index); */
	layer_close();
}


</script>

</body>

</html>
